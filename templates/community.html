{% extends "base.html" %}

{% block title %}Community{% endblock %}

{% block body %}
<div class="container mt-5 pt-5">
    <div class="row mb-5">
        <div class="col-12 text-center">
            <h1 class="display-4 fw-bold" style="color: var(--primary-color);">SynoCast Community</h1>
            <p class="lead text-muted">Share photos, report conditions, and plan your adventures.</p>
        </div>
    </div>

    <ul class="nav nav-pills mb-4 justify-content-center gap-3" id="communityTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active rounded-pill px-4" id="feed-tab" data-bs-toggle="tab" data-bs-target="#feed"
                type="button" role="tab">Community Feed</button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link rounded-pill px-4" id="contribute-tab" data-bs-toggle="tab"
                data-bs-target="#contribute" type="button" role="tab">Contribute</button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link rounded-pill px-4" id="planner-tab" data-bs-toggle="tab" data-bs-target="#planner"
                type="button" role="tab">Event Planner</button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link rounded-pill px-4" id="leaderboard-tab" data-bs-toggle="tab"
                data-bs-target="#leaderboard" type="button" role="tab">Leaderboard</button>
        </li>
    </ul>

    <div class="tab-content" id="communityTabContent">
        <!-- Feed Tab -->
        <div class="tab-pane fade show active" id="feed" role="tabpanel">
            <div class="masonry-feed" id="feed-container">
                <!-- Items injected by JS -->
                <div class="text-center w-100 py-5">
                    <div class="spinner-border text-primary" role="status"></div>
                </div>
            </div>
        </div>

        <!-- Contribute Tab -->
        <div class="tab-pane fade" id="contribute" role="tabpanel">
            <div class="row justify-content-center">
                <div class="col-md-6 mb-4">
                    <div class="card h-100 border-0 shadow-sm">
                        <div class="card-body p-4">
                            <h3 class="card-title h5 mb-3"><i class="fas fa-camera me-2 text-primary"></i>Upload Photo
                            </h3>
                            <form id="uploadForm">
                                <div class="mb-3">
                                    <label class="form-label">Select Photo</label>
                                    <input type="file" class="form-control" name="photo" accept="image/*" required>
                                </div>
                                <div class="mb-3">
                                    <input type="text" class="form-control" name="caption"
                                        placeholder="Add a caption..." required>
                                </div>
                                <input type="hidden" name="lat" id="up-lat">
                                <input type="hidden" name="lon" id="up-lon">
                                <input type="hidden" name="city" id="up-city">
                                <button type="submit" class="btn btn-primary w-100 rounded-pill">Upload</button>
                            </form>
                        </div>
                    </div>
                </div>
                <div class="col-md-6 mb-4">
                    <div class="card h-100 border-0 shadow-sm">
                        <div class="card-body p-4">
                            <h3 class="card-title h5 mb-3"><i class="fas fa-bullhorn me-2 text-primary"></i>Report
                                Weather</h3>
                            <form id="reportForm">
                                <div class="mb-3">
                                    <label class="form-label">Current Condition</label>
                                    <select class="form-select" name="condition" required>
                                        <option value="Clear">Clear</option>
                                        <option value="Clouds">Cloudy</option>
                                        <option value="Rain">Rain</option>
                                        <option value="Snow">Snow</option>
                                        <option value="Thunderstorm">Thunderstorm</option>
                                        <option value="Fog">Fog</option>
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <textarea class="form-control" name="comment" rows="3"
                                        placeholder="What's happening? (e.g., 'Flooding on Main St', 'Colder than forecast')"></textarea>
                                </div>
                                <input type="hidden" name="lat" id="rep-lat">
                                <input type="hidden" name="lon" id="rep-lon">
                                <input type="hidden" name="city" id="rep-city">
                                <input type="hidden" name="api_condition" value="Unknown"> <!-- Updated by JS -->
                                <button type="submit" class="btn btn-primary w-100 rounded-pill">Submit Report</button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Planner Tab -->
        <div class="tab-pane fade" id="planner" role="tabpanel">
            <div class="row justify-content-center">
                <div class="col-lg-8">
                    <div class="card border-0 shadow-sm">
                        <div class="card-body p-5 text-center">
                            <h2 class="h4 mb-4">AI Event Planner</h2>
                            <p class="text-muted mb-4">Tell us what you want to do, and we'll find the best time based
                                on the forecast.</p>
                            <div class="input-group mb-3">
                                <input type="text" id="activityInput" class="form-control form-control-lg"
                                    placeholder="e.g., Go for a hike, Have a BBQ...">
                                <button class="btn btn-primary px-4" type="button" id="planBtn">Plan It</button>
                            </div>
                            <div id="plannerResults" class="text-start mt-4 planner-response"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Leaderboard Tab -->
        <div class="tab-pane fade" id="leaderboard" role="tabpanel">
            <div class="row">
                <div class="col-lg-8 mb-4">
                    <div class="card border-0 shadow-sm">
                        <div class="card-header bg-white border-bottom-0 pt-4 px-4">
                            <h3 class="h5 mb-0"><i class="fas fa-trophy text-warning me-2"></i>Top Contributors</h3>
                        </div>
                        <div class="card-body p-0">
                            <div class="list-group list-group-flush" id="leaderboard-list">
                                <div class="text-center p-4">
                                    <div class="spinner-border spinner-border-sm text-primary"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-lg-4">
                    <!-- My Stats -->
                    <div class="card border-0 shadow-sm mb-4 bg-primary text-white">
                        <div class="card-body text-center p-4">
                            <h6 class="text-white-50">MY KARMA</h6>
                            <h2 class="display-3 fw-bold mb-0" id="my-points">0</h2>
                            <p class="small text-white-50">Points</p>
                        </div>
                    </div>

                    <div class="card border-0 shadow-sm">
                        <div class="card-header bg-white border-bottom-0 pt-4 px-4">
                            <h5 class="card-title h6 mb-0">My Badges</h5>
                        </div>
                        <div class="card-body">
                            <div id="my-badges" class="d-flex flex-wrap gap-2 justify-content-center">
                                <div class="text-center p-2">
                                    <div class="spinner-border spinner-border-sm text-muted"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        // Load Feed
        loadFeed();

        // Get Location for forms
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(pos => {
                const lat = pos.coords.latitude;
                const lon = pos.coords.longitude;

                document.querySelectorAll('input[name="lat"]').forEach(el => el.value = lat);
                document.querySelectorAll('input[name="lon"]').forEach(el => el.value = lon);

                // Reverse Geocode for City
                fetch(`/api/geocode/reverse?lat=${lat}&lon=${lon}`)
                    .then(r => r.json())
                    .then(d => {
                        const city = d.address.city || d.address.town || d.address.village || "Unknown Location";
                        document.querySelectorAll('input[name="city"]').forEach(el => el.value = city);
                    });

                // Fetch current weather for report comparison
                fetch(`/api/weather?lat=${lat}&lon=${lon}`)
                    .then(r => r.json())
                    .then(d => {
                        if (d.current) {
                            const cond = d.current.weather[0].main;
                            document.querySelector('input[name="api_condition"]').value = cond;
                        }
                    });
            });
        }

        // Handle Upload
        document.getElementById('uploadForm').addEventListener('submit', function (e) {
            e.preventDefault();
            const formData = new FormData(this);
            fetch('/api/community/photo', {
                method: 'POST',
                body: formData,
                headers: { 'X-CSRFToken': document.querySelector('meta[name="_csrf_token"]').content }
            })
                .then(r => r.json())
                .then(res => {
                    if (res.success) {
                        alert('Photo uploaded!');
                        this.reset();
                        loadFeed(); // Refresh feed
                        document.getElementById('feed-tab').click();
                    } else {
                        alert('Error: ' + res.error);
                    }
                });
        });

        // Handle Report
        document.getElementById('reportForm').addEventListener('submit', function (e) {
            e.preventDefault();
            const data = Object.fromEntries(new FormData(this));
            fetch('/api/report_weather', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('meta[name="_csrf_token"]').content
                },
                body: JSON.stringify(data)
            })
                .then(r => r.json())
                .then(res => {
                    if (res.success) {
                        alert('Report submitted!');
                        this.reset();
                        loadFeed();
                        document.getElementById('feed-tab').click();
                    } else {
                        alert('Error: ' + res.error);
                    }
                });
        });

        // Handle Planner
        document.getElementById('planBtn').addEventListener('click', function () {
            const activity = document.getElementById('activityInput').value;
            const lat = document.getElementById('up-lat').value; // Reuse queried lat
            const lon = document.getElementById('up-lon').value;

            if (!activity) return alert('Please enter an activity');
            if (!lat) return alert('Location needed for planning. Enable location.');

            const results = document.getElementById('plannerResults');
            results.innerHTML = '<div class="text-center"><div class="spinner-border text-primary spinner-border-sm"></div> Thinking...</div>';

            fetch('/api/planning/suggest', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('meta[name="_csrf_token"]').content
                },
                body: JSON.stringify({ activity, lat, lon })
            })
                .then(r => r.json())
                .then(d => {
                    if (d.html) {
                        results.innerHTML = d.html;
                    } else {
                        results.innerHTML = '<p class="text-danger">Could not get suggestions.</p>';
                    }
                });
        });
        // Leaderboard Tab Click
        document.getElementById('leaderboard-tab').addEventListener('shown.bs.tab', function () {
            loadLeaderboard();
            loadMyStats();
        });
    });

    function loadLeaderboard() {
        fetch('/api/community/leaderboard')
            .then(r => r.json())
            .then(data => {
                const list = document.getElementById('leaderboard-list');
                if (!data.length) {
                    list.innerHTML = '<div class="p-4 text-center text-muted">No records yet.</div>';
                    return;
                }

                let html = '';
                data.forEach((u, i) => {
                    const medal = i === 0 ? 'ðŸ¥‡' : i === 1 ? 'ðŸ¥ˆ' : i === 2 ? 'ðŸ¥‰' : `#${i + 1}`;
                    html += `
                        <div class="list-group-item border-0 d-flex justify-content-between align-items-center px-4 py-3">
                            <div class="d-flex align-items-center">
                                <span class="fw-bold me-3" style="width: 30px; font-size: 1.2rem;">${medal}</span>
                                <span class="fw-medium">${u.display_name}</span>
                            </div>
                            <span class="badge bg-light text-primary rounded-pill px-3 py-2 fs-6">
                                ${u.total_score} pts
                            </span>
                        </div>
                    `;
                });
                list.innerHTML = html;
            });
    }

    function loadMyStats() {
        fetch('/api/user/badges')
            .then(r => r.json())
            .then(data => {
                // Points
                document.getElementById('my-points').textContent = data.total_points || 0;

                // Badges
                const container = document.getElementById('my-badges');
                if (!data.all.length) {
                    container.innerHTML = '<small class="text-muted">No badges available</small>';
                    return;
                }

                let html = '';
                // Create map of earned badges
                const earnedMap = new Map((data.earned || []).map(b => [b.name, b]));

                data.all.forEach(badge => {
                    const isEarned = earnedMap.has(badge.name);
                    const opacity = isEarned ? '1' : '0.3';
                    const tooltip = isEarned ? `Earned: ${new Date(earnedMap.get(badge.name).awarded_at).toLocaleDateString()}` : `Locked: ${badge.description}`;

                    html += `
                        <div class="text-center p-2" title="${tooltip}" style="opacity: ${opacity}; width: 80px;">
                            <div class="rounded-circle bg-light d-flex align-items-center justify-content-center mx-auto mb-2" style="width: 50px; height: 50px;">
                                <i class="fas ${badge.icon_class} fa-lg text-primary"></i>
                            </div>
                            <small class="d-block lh-1 text-muted" style="font-size: 10px;">${badge.name}</small>
                        </div>
                    `;
                });
                container.innerHTML = html;
            });
    }

    function loadFeed() {
        fetch('/api/community/feed?limit=30')
            .then(r => r.json())
            .then(data => {
                const container = document.getElementById('feed-container');
                if (!data.length) {
                    container.innerHTML = '<p class="text-center text-muted">No posts yet. Be the first!</p>';
                    return;
                }

                let html = '';
                data.forEach(item => {
                    if (item.type === 'photo') {
                        // Check if date needs parsing or already ISO
                        const dateStr = item.created_at.endsWith('Z') ? item.created_at : item.created_at + 'Z';

                        html += `
                    <div class="card masonry-item user-photo-card shadow-sm border-0">
                        <img src="/assets/user_uploads/${item.filename}" alt="${item.caption}">
                        <div class="card-body">
                            <p class="card-text small text-muted mb-1"><i class="fas fa-map-marker-alt me-1"></i> ${item.city || 'Unknown'}</p>
                            <p class="card-text fw-bold">${item.caption}</p>
                            <p class="card-text"><small class="text-muted">${new Date(dateStr).toLocaleDateString()}</small></p>
                        </div>
                    </div>`;
                    } else {
                        const dateStr = item.reported_at.endsWith('Z') ? item.reported_at : item.reported_at + 'Z';
                        html += `
                    <div class="card masonry-item report-card shadow-sm border-0" style="background-color: var(--surface-color); border: 1px solid var(--divider-color) !important;">
                        <div class="card-body">
                            <h5 class="card-title h6 text-primary"><i class="fas fa-clipboard-check me-2"></i>Community Report</h5>
                            <p class="mb-1"><strong>${item.reported_condition}</strong> in ${item.city || 'Unknown'}</p>
                            ${item.comment ? `<p class="text-muted fst-italic">"${item.comment}"</p>` : ''}
                             <p class="card-text"><small class="text-muted">${new Date(dateStr).toLocaleDateString()}</small></p>
                        </div>
                    </div>`;
                    }
                });
                container.innerHTML = html;
            });
    }
</script>
{% endblock %}